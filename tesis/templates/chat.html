{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat con la IA</title>
    <!-- No necesitas Font Awesome ya que usaremos imágenes personalizadas -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            justify-content: space-between;
            /* Distribuye los sidebars y el main-container */
            align-items: stretch;
            height: 100vh;
            overflow: hidden;
        }

        /* Estilos comunes para ambos sidebars */
        .sidebar {
            position: relative;
            /* Para posicionar el botón de toggle correctamente */
            background-color: #1f2937;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: width 0.3s ease;
            overflow: hidden;
            /* Oculta el contenido cuando está cerrado */
        }

        .sidebar h2 {
            margin: 0 0 20px;
            font-size: 18px;
            color: #f0f4f8;
        }

        /* Sidebar Izquierdo */
        .left-sidebar {
            width: 20%;
            /* Ancho inicial */
        }

        /* Sidebar Derecho */
        .right-sidebar {
            width: 20%;
            /* Ancho inicial */
        }

        /* Estilos para los botones de toggle */
        .toggle-button {
            position: absolute;
            top: 10px;
            /* Ajusta según tu diseño */
            background-color: transparent;
            /* Fondo transparente para solo mostrar el ícono */
            border: none;
            cursor: pointer;
            padding: 0;
            width: 24px;
            /* Tamaño del ícono */
            height: 24px;
            /* Elimina el padding para que la imagen ocupe todo el botón */
        }

        /* Toggle Button Izquierdo */
        .toggle-button-left {
            right: 10px;
            /* Posiciona el botón fuera del sidebar izquierdo */
        }

        /* Toggle Button Derecho */
        .toggle-button-right {
            right: 10px;
            /* Posiciona el botón fuera del sidebar derecho */
        }

        /* Imágenes de las flechas */
        .toggle-button img {
            width: 24px;
            /* Ajusta el tamaño según sea necesario */
            height: 24px;
            transition: transform 0.3s ease;
        }

        .sidebar:not(.collapsed) .toggle-button img {
            transform: rotate(180deg);
        }

        .sidebar.collapsed .toggle-button img {
            transform: rotate(0deg);
        }

        .right-sidebar:not(.collapsed) .toggle-button-right img {
            transform: rotate(0deg);
            /* Flecha apuntando a la izquierda */
            transition: transform 0.3s ease;
        }

        .right-sidebar.collapsed .toggle-button-right img {
            transform: rotate(180deg);
            /* Flecha apuntando a la derecha */
            transition: transform 0.3s ease;
        }

        /* Sidebar Colapsado Izquierdo */
        .left-sidebar.collapsed {
            width: 10px;
            /* Ancho reducido cuando está cerrado */
        }

        /* Sidebar Colapsado Derecho */
        .right-sidebar.collapsed {
            width: 10px;
            /* Ancho reducido cuando está cerrado */
        }

        .sidebar .sidebar-content,
        .left-sidebar .user-info-container {
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }

        /* Estado Colapsado */
        .left-sidebar.collapsed .sidebar-content,
        .left-sidebar.collapsed .user-info-container,
        .right-sidebar.collapsed .sidebar-content {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-20px);
            /* Opcional: desplaza el contenido hacia la izquierda */
        }

        /* Estado Expandido */
        .sidebar:not(.collapsed) .sidebar-content,
        .left-sidebar:not(.collapsed) .user-info-container {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        /* Main Container */
        .main-container {
            flex-grow: 1;
            /* Permite que el contenedor crezca para llenar el espacio disponible */
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            /* Permite el desplazamiento vertical si el contenido es demasiado grande */
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            margin-right: 20px;
            overflow: hidden;
            overflow-y: auto;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: center;
            /* Centra los elementos horizontalmente */
            position: relative;
            /* Necesario para posicionar el botón absoluto */
            background-color: #f7f7f7;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }

        .chat-history {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        .chat-history .message {
            margin-bottom: 15px;
        }

        .chat-history .user-message span,
        .chat-history .bot-message span {
            display: inline-block;
            padding: 10px;
            border-radius: 20px;
            max-width: 70%;
            white-space: pre-wrap;
        }

        .chat-history .user-message span {
            background-color: #007bff;
            color: white;
        }

        .chat-history .bot-message span {
            background-color: #e9ecef;
            color: #333;
        }

        .chat-input {
            padding: 20px;
            background-color: #f7f7f7;
            border-top: 1px solid #ddd;
        }

        .chat-input form {
            display: flex;
            align-items: flex-end;
            /* Alinea el botón de enviar al final de la textarea */

            width: 100%;
        }

        .chat-input textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background-color: #fff;
            color: #333;
            resize: none;
            /* Opcional: evita que el usuario cambie el tamaño manualmente */
            min-height: 50px;
            /* Altura mínima */
            max-height: 150px;
            /* Altura máxima antes de mostrar scroll */
            overflow: hidden;
            /* Oculta la barra de desplazamiento */
            font-size: 16px;
            box-sizing: border-box;
        }

        .chat-input button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .chat-input button:disabled {
            background-color: #b0b0b0;
            cursor: not-allowed;
        }

        /* Información del Paciente */
        .patient-info-content {
            /* Asegura que el contenido del sidebar derecho tenga un scroll si es necesario */
            overflow-y: auto;
            max-height: calc(100vh - 80px);
            /* Ajusta según el padding y el tamaño del botón */
        }

        .patient-info-content h2 {
            margin-top: 0;
            text-align: center;
            font-size: 20px;
            color: #ffffff;
        }

        .patient-info-content h4 {
            margin-top: 0;
            font-size: 16px;
            color: #ffffff;
        }


        .patient-info-content p,
        .patient-info-content label {
            margin-bottom: 10px;
            font-size: 14px;
            color: #f0f4f8;
        }

        .patient-info-content strong {
            font-weight: bold;
        }

        .diagnosis-section {
            margin-top: 20px;
        }

        .diagnosis-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .diagnosis-section input[type="text"],
        .diagnosis-section textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }

        .diagnosis-section textarea {
            resize: vertical;
        }

        #save-diagnosis,
        #view-patient-info {
            display: left;
            margin-top: 20px;
            padding: 15px;
            width: 40%;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-align: center;

        }

        #save-diagnosis {
            float: left;
        }

        #save-diagnosis:hover {
            background-color: #218838;
        }

        #view-patient-info {
            float: right;
        }

        #view-patient-info:hover {
            background-color: #218838;
        }


        /* Pacientes Recientes */
        .recent-patients {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #1f2937;
        }

        .recent-patients button {
            padding: 10px;
            background-color: #4e678b;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.3s ease;
            color: #f0f4f8;
            font-size: medium;
        }

        .recent-patients button:hover {
            background-color: #181f2b;
        }

        /* Información del Usuario */
        .user-info-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }

        .user-info {
            padding: 10px;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: medium;
            width: 95%;
            text-align: center;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background-color: #f0f0f0;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 5px;
            overflow: hidden;
            width: 100%;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }

        .dropdown-content a:last-child {
            border-bottom: none;
        }

        .dropdown-content a:hover {
            background-color: #ddd;
        }

        .user-info-container:hover .dropdown-content {
            display: block;
        }

        .recent-patients-list {
            margin-top: 20px;
            padding: 0;
            list-style-type: none;
        }

        .recent-patients-list li {
            background-color: #4e678b;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .recent-patients-list li:hover {
            background-color: #181f2b;
        }

        .chat-header {
            display: flex;
            align-items: center;
            background-color: #f7f7f7;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            float: center;
        }

        .home-button {
            position: absolute;
            /* Posiciona el botón de manera absoluta dentro de .chat-header */
            left: 15px;
            /* Ajusta la distancia desde la izquierda */
            color: #1f2937;
            /* Color del ícono o texto */
            text-decoration: none;
            /* Elimina el subrayado del enlace */
            font-size: 24px;
        }

        .home-button i {
            font-size: 24px;
            /* Tamaño del ícono */
            transition: transform 0.3s ease;
        }

        .home-button:hover i {
            transform: scale(1.2);
            /* Efecto al pasar el cursor */
        }

        /* Media Queries para Responsividad */
        @media (max-width: 768px) {
            .left-sidebar {
                width: 25%;
            }

            .right-sidebar {
                width: 20%;
            }

            .left-sidebar.collapsed,
            .right-sidebar.collapsed {
                width: 40px;
            }

            .main-container {
                flex-direction: column;
            }

            .chat-container,
            .patient-info-content {
                max-width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 480px) {

            .left-sidebar.collapsed,
            .right-sidebar.collapsed {
                width: 30px;
                /* Ancho aún más reducido */
            }

            .toggle-button-left,
            .toggle-button-right {
                width: 25px;
                height: 25px;
            }

            .toggle-button img {
                width: 24px;
                height: 24px;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar Izquierdo: Pacientes Recientes -->
    <div class="sidebar left-sidebar" id="recent-patients-sidebar">
        <button id="toggle-button-left" class="toggle-button toggle-button-left">
            <img src="{% static 'images/arrow.png' %}" alt="Cerrar Sidebar Pacientes Recientes" id="toggle-icon-left">
        </button>
        <div class="sidebar-content">
            <h2>Pacientes Recientes</h2>
            <div class="recent-patients" id="recent-patients">
                <!-- Aquí se insertarán los pacientes dinámicamente -->
            </div>
        </div>
        <div class="user-info-container">
            <div class="user-info">Gustavo Arnaldi Lopez</div>
            <div class="dropdown-content">
                <a href="#">Ajustes del usuario</a>
                <a href="{% url 'logout' %}">Cerrar sesión</a>
            </div>
        </div>
    </div>

    <!-- Sidebar Derecho: Información del Paciente -->


    <!-- Main Container -->
    <div class="main-container">
        <div class="chat-container">
            <div class="chat-header">
                <a href="{% url 'home' %}" class="home-button" title="Volver al Inicio">
                    <img src="{% static 'images/home.svg' %}">
                </a>
                <span class="chat-title">Chat con IA</span>
            </div>
            <div class="chat-history" id="chat-history">
                <!-- Aquí se irán mostrando los mensajes -->
            </div>
            <div class="chat-input">
                <form id="chat-form">
                    {% csrf_token %}
                    <textarea id="user_input" name="user_input" placeholder="Escribe tu mensaje..."></textarea>
                    <button type="submit" id="send-button">Enviar</button>
                </form>
            </div>
        </div>
    </div>
    <div class="sidebar right-sidebar" id="patient-info-sidebar">
        <button id="toggle-button-right" class="toggle-button toggle-button-right">
            <img src="{% static 'images/arrow.png' %}" alt="Cerrar Sidebar Información del Paciente"
                id="toggle-icon-right">
        </button>
        <div class="sidebar-content">
            <h2>Información del Paciente</h2>
            <div class="patient-info-content" id="patient-info-content">
                <!-- Aquí se insertará la información del paciente dinámicamente -->
                <p><strong>Nombre:</strong> {{ patient_data.first_name }} {{ patient_data.last_name }}</p>
                <p><strong>Fecha de Nacimiento:</strong> {{ patient_data.birth_date }}</p>
                <p><strong>Género:</strong> {{ patient_data.genre }}</p>

                <h4>Síntomas</h4>
                <p><strong>Físicos:</strong> {{ patient_data.sintomas.fisicos }}</p>
                <p><strong>Funcionamiento social:</strong> {{ patient_data.sintomas.sociales }}</p>
                <p><strong>Emocionales:</strong> {{ patient_data.sintomas.emocionales }}</p>
                <p><strong>Comportamiento:</strong> {{ patient_data.sintomas.comportamiento }}</p>

                <h4>Historial Médico</h4>
                <p><strong>Historial Personal:</strong> {{ patient_data.medical_history.personal }}</p>
                <p><strong>Historial Familiar:</strong> {{ patient_data.medical_history.family }}</p>
                <p><strong>Historial Clínico:</strong> {{ patient_data.medical_history.clinical }}</p>

                <h4>Diagnóstico Previo</h4>
                <form id="update-diagnosis-form" class="diagnosis-section">
                    {% csrf_token %}
                    <label for="diagnosis">Hipótesis diagnóstica:</label>
                    <input type="text" id="diagnosis" name="diagnosis" value="{{ patient_data.diagnostico }}" required>

                    <label for="diagnosis_details">Detalles del Diagnóstico:</label>
                    <textarea id="diagnosis_details" name="diagnosis_details"
                        rows="3">{{ patient_data.diagnosis_details }}</textarea>

                    <label for="additional_diagnosis">Diagnóstico Adicional:</label>
                    <textarea id="additional_diagnosis" name="additional_diagnosis"
                        rows="3">{{ patient_data.additional_diagnosis }}</textarea>

                    <input type="hidden" name="patient_id" value="{{ patient_data.id }}">
                </form>
                <button id="save-diagnosis" type="submit" data-patient-id="{{ patient_data.id }}">Guardar diagnóstico
                    del paciente</button>
                <button id="view-patient-info" type="submit" data-patient-id="{{ patient_data.id }}">Ver datos
                    adicionales</button>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script src=" https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {

            // Manejo del formulario de chat
            $('#chat-form').on('submit', function (event) {
                event.preventDefault();
                var user_input = $('#user_input').val();
                var sendButton = $('#send-button');

                // Deshabilitar el botón de enviar
                sendButton.prop('disabled', true);

                $.ajax({
                    url: '{% url "get_response" %}',
                    method: 'POST',
                    data: {
                        'user_input': user_input,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (data) {
                        console.log(data); // Verifica qué se está devolviendo
                        $('#chat-history').append('<div class="message user-message"><span>Tú: ' + user_input + '</span></div>');
                        $('#chat-history').append('<div class="message bot-message"><span>IA: ' + data.response + '</span></div>');
                        $('#user_input').val('');
                        $('#chat-history').scrollTop($('#chat-history')[0].scrollHeight);

                        // Habilitar el botón de enviar
                        sendButton.prop('disabled', false);
                    },
                    error: function (xhr, errmsg, err) {
                        $('#chat-history').append('<div class="message bot-message"><span>Error al enviar el mensaje.</span></div>');

                        // Habilitar el botón de enviar
                        sendButton.prop('disabled', false);
                    }
                });
            });

            // Manejo del botón de guardar diagnóstico
            $('#save-diagnosis').on('click', function (event) {
                event.preventDefault(); // Evita el envío del formulario
                var diagnosis = $('#diagnosis').val();
                var diagnosis_details = $('#diagnosis_details').val();
                var additional_diagnosis = $('#additional_diagnosis').val();
                var patient_id = $(this).data('patient-id');

                $.ajax({
                    url: '/update_diagnosis/' + patient_id + '/',
                    method: 'POST',
                    data: {
                        'diagnosis': diagnosis,
                        'diagnosis_details': diagnosis_details,
                        'additional_diagnosis': additional_diagnosis,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (data) {
                        alert('Diagnóstico actualizado correctamente');
                        window.location.href = '{% url "home" %}';  // Redirigir a la página de inicio después de guardar
                    },
                    error: function (xhr, errmsg, err) {
                        alert('Error al guardar el diagnóstico');
                    }
                });
            });

            function autoResizeTextarea(textarea) {
                $(textarea).css('height', 'auto'); // Restablece la altura
                var newHeight = textarea.scrollHeight;
                var maxHeight = 150; // Debe coincidir con el max-height en CSS
                if (newHeight > maxHeight) {
                    newHeight = maxHeight;
                    $(textarea).css('overflow-y', 'auto'); // Añade scroll si supera el max-height
                } else {
                    $(textarea).css('overflow-y', 'hidden'); // Oculta el scroll
                }
                $(textarea).css('height', newHeight + 'px'); // Asigna la nueva altura
            }

            // Aplica la función al cargar y al escribir en la textarea
            $('#user_input').each(function () {
                autoResizeTextarea(this);
            }).on('input', function () {
                autoResizeTextarea(this);
            });
            // Función para actualizar pacientes recientes
            function updateRecentPatients() {
                fetch('/get_recent_patients/')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Datos recibidos:', data);
                        const recentPatientsContainer = document.getElementById('recent-patients');
                        recentPatientsContainer.innerHTML = '';

                        data.recent_patients.forEach(patient => {
                            const patientElement = document.createElement('button');
                            patientElement.textContent = `${patient.name} - ${patient.diagnosis}`;
                            patientElement.setAttribute('data-patient-id', patient.id);

                            // Evento para redirigir al chat con la IA
                            patientElement.addEventListener('click', function () {
                                window.location.href = `/chat?patient_id=${patient.id}`;
                            });

                            recentPatientsContainer.appendChild(patientElement);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            }

            updateRecentPatients();

            // Manejo del token CSRF para las solicitudes AJAX
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrftoken = getCookie('csrftoken');

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            // Implementación del toggle del sidebar izquierdo (Pacientes Recientes)
            $('#toggle-button-left').on('click', function () {
                $('#recent-patients-sidebar').toggleClass('collapsed');
                // Las transformaciones de la flecha se manejan con CSS
                if ($('#recent-patients-sidebar').hasClass('collapsed')) {
                    $('#toggle-icon-left').attr('alt', 'Abrir Sidebar Pacientes Recientes');
                } else {
                    $('#toggle-icon-left').attr('alt', 'Cerrar Sidebar Pacientes Recientes');
                }
            });

            // Toggle Sidebar Derecho
            $('#toggle-button-right').on('click', function () {
                $('#patient-info-sidebar').toggleClass('collapsed');
                if ($('#patient-info-sidebar').hasClass('collapsed')) {
                    $('#toggle-icon-right').attr('alt', 'Abrir Sidebar Información del Paciente');
                } else {
                    $('#toggle-icon-right').attr('alt', 'Cerrar Sidebar Información del Paciente');
                }
            });

        });
    </script>
</body>

</html>